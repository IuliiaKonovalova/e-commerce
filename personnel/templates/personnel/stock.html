{% extends "base.html" %}
{% load static %}


{% block content %}
  <div class="dashboard">
  {% comment %} Limit access for customers {% endcomment %}
    {% if request.user.is_authenticated and not request.user.profile.role.id == 1 %}
      <div class="dashboard__main">
          <h1 class="dashboard__main--name">Stock</h1>
      </div>
      {% comment %} Summary of units without stock {% endcomment %}
      <div class="data__main--stock">
        <div class="products__stock--no">
          <div class="products__stock--no--title">
            You have <strong>{{ products_without_stock.count }}</strong> Units without stock
          </div>
          {% comment %} show-hide button for units without stock {% endcomment %}
          {% if products_without_stock.count > 0 %}
            <button id="without-stock" class="btn btn__add">
              <i class="fas fa-chevron-down"></i>
              Show
            </button>
            {% comment %} dropdown table for produccts without stock {% endcomment %}
            <div class="hidden nostock__units" id="without-stock-table">
              {% for unit in products_without_stock %}
                <a class="nostock__unit" href="{% url 'product_inventory_details' pk=unit.product.pk inventory_pk=unit.id %}" aria-label="Go to product inventories details">
                  <div class="products__stock--no--unit--sku">
                    {{ unit.sku }}
                    <i class="fa fa-external-link" aria-hidden="true"></i>
                  </div>
                  <div class="products__stock--no--unit--name">{{ unit.product.name }}</div>
                </a>
              {% endfor %}
            </div>
          {% endif %}
          </div>
        </div>
        {% comment %} Stock table data {% endcomment %}
        <div class="stock__table--container">
          <table class="stock__table">
            <tr>
              <th>SKU</th>
              <th>Alert</th>
              <th>Left</th>
              <th>Bought</th>
              <th>Sold</th>
              <th>Checked</th>
              <th>Inconcistency</th>
            </tr>
            {% for stock in all_stock %}
            {% if stock in  stocks_without_units %}
              <tr style="background-color: #ffc0cb;">
            {% else %}
              <tr>
            {% endif %}
              <td class="stock__sku">
                {% if stock.product_inventory.sku %}
                <a class="stock__item--link" aria-label="Go to product inventories details"
                    href="{% url 'product_inventory_details' pk=stock.product_inventory.product.pk inventory_pk=stock.product_inventory.id %}">
                      {{ stock.product_inventory.sku }}
                      <i class="fa fa-external-link" aria-hidden="true"></i>
                </a>
                {% else %}
                  No SKU
                {% endif %}
              </td>
              <td>
                {% if stock.units < 50 and stock.units >= 25 %}
                  <div class="data__accent--yellow">
                    <i class="fa fa-exclamation-triangle"></i>
                  </div>
                {% elif stock.units < 25 and stock.units >= 10 %}
                  <div class="data__accent--orange">
                    <i class="fa fa-exclamation-triangle"></i>
                  </div>
                {% elif stock.units < 10 and stock.units >= 0 %}
                  <div class="data__accent--redish">
                    <i class="fa fa-exclamation-triangle"></i>
                  </div>
                {% elif stock.units == 0 %}
                  <div class="data__accent--red">
                    <i class="fa fa-exclamation-triangle"></i>
                  </div>
                {% else %}
                  <div class="data__accent--green">
                    <i class="fa fa-exclamation-triangle"></i>
                  </div>
                {% endif %}
              </td>
              <td>{{ stock.units }}</td>
              <td>{{ stock.units_variable }}</td>
              <td>{{ stock.units_sold }}</td>
              <td>{{ stock.last_checked }}</td>
              <td>
                {% if stock in stock_inconsistency %}
                  <div class="data__accent--red">
                    <i class="fa fa-exclamation-triangle"></i>
                  </div>
                {% else %}
                  <div class="data__accent--green">
                    <i class="fa fa-exclamation-triangle"></i>
                  </div>
                {% endif %}
              </td>
            {% endfor %}
          </table>
        </div>
      </div>
      {% comment %} Control Pagination {% endcomment %}
      {% if all_stock.paginator.num_pages %}
        {% if not all_stock.paginator.num_pages == 1 %}
          <div class="pagination">
            <div class="pagination__navigation">
              {% if all_stock.has_previous and not all_stock.has_next %}
                <a href="?page={{ all_stock.previous_page_number }}" class="pagination__navigation--btn"
                  aria-label="Go to previous page results">
                  <i class="fas fa-chevron-left"></i>
                </a>
                <div class="pagination__navigation--fake">
                  <i class="fas fa-chevron-right"></i>
                </div>
              {% elif all_stock.has_next and not all_stock.has_previous %}
                <div class="pagination__navigation--fake">
                  <i class="fas fa-chevron-left"></i>
                </div>
                <a href="?page={{ all_stock.next_page_number }}" class="pagination__navigation--btn"
                  aria-label="Go to next page results">
                  <i class="fas fa-chevron-right"></i>
                </a>
              {% elif all_stock.has_next and all_stock.has_previous %}
                <a href="?page={{ all_stock.previous_page_number }}" class="pagination__navigation--btn"
                  aria-label="Go to previous page results">
                  <i class="fas fa-chevron-left"></i>
                </a>
                <a href="?page={{ all_stock.next_page_number }}" class="pagination__navigation--btn"
                  aria-label="Go to next page results">
                  <i class="fas fa-chevron-right"></i>
                </a>
              {% else %}
                <div class="pagination__navigation--fake">
                  <i class="fas fa-chevron-left"></i>
                </div>
                <div class="pagination__navigation--fake">
                  <i class="fas fa-chevron-right"></i>
                </div>
              {% endif %}
            </div>
            <div class="pagination__location">
              Page <span>{{ all_stock.number }}</span> of {{ all_stock.paginator.num_pages }}
            </div>
          </div>
        {% endif %}
      {% endif %}
    {% else %}
      <div class="dashboard__main">
        <h1 class="dashboard__main--name">
          You are not authorized to delete categories
        </h1>
      </div>
    {% endif %}
  </div>
{% endblock %}

{% block postloadjs_extra %}
  <script>
    $(document).ready(function() {
      let btnWithoutStock = $('#without-stock');
      let tableWithoutStock = $('#without-stock-table');
      // show table without stock
      btnWithoutStock.on('click', function() {
        tableWithoutStock.toggleClass('hidden');
        // control button text
        if (tableWithoutStock.hasClass('hidden')) {
          btnWithoutStock.html('<i class="fas fa-chevron-down"></i> Show');
        } else {
          btnWithoutStock.html('<i class="fas fa-chevron-up"></i> Hide');
        }
      });
    });
  </script>
{% endblock %}
